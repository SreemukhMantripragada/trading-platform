# Risk

## Responsibilities
- Enforce portfolio- and symbol-level budgets before orders reach the execution stack.
- Size positions based on stop-loss metadata or monetary caps.
- Provide visibility into drawdowns, notional usage, and broker cash availability.

## Services & Scripts
| Path | Description | Inputs → Outputs |
| --- | --- | --- |
| `risk/manager_v2.py` | Core risk manager consuming `orders`, resizing via budgets, and emitting `orders.sized`. | Kafka `orders` → Kafka `orders.sized`, Postgres `orders` |
| `risk/order_budget_guard.py` | Applies per-bucket caps and throttles before forwarding to execution. | Kafka `orders.sized` → Kafka `orders.allowed` |
| `risk/rebalance_daemon.py` | Periodically recomputes bucket weights from YAML configs, writing runtime configs. | YAML → `configs/risk_budget.runtime.yaml` |
| `risk/budget_source.py` | Exposes budget state as a Prometheus exporter. | Postgres → HTTP metrics |
| `risk/spend_tracker.py` | Audits realized turnover/fills to keep budgets in sync. | Kafka `fills`, Postgres |
| `risk/position_sizer.py` | Utility module for translating risk parameters into lot sizes. | Library |

## Configuration
- Primary settings live in `configs/risk_budget.yaml` (per-bucket percentages, risk-per-trade, tick sizes, per-strategy caps).
- Runtime overrides generated by `risk/rebalance_daemon.py` are written to `configs/risk_budget.runtime.yaml`.
- Broker equity and available funds are fetched through `brokers/zerodha_account.py`; ensure Kite auth is configured.
- Prometheus ports default to `8023` for `order_budget_guard` and `8024+` for exporters (override via environment variables).

## Running Locally
- Risk manager: `make risk-v2`
- Budget guard: `make budget-guard`
- Spend tracker: `python risk/spend_tracker.py --from 2024-01-01`
- Drawdown exporter: `make exporter-dd`

## Operational Notes
- Risk manager expects `extra.signal` metadata with `entry_px` and `stop_px`. When absent, it falls back to per-strategy monetary caps.
- Orders rejected for insufficient budget are tagged with `extra.risk.reason=insufficient_budget`; monitor this via PostgreSQL or Grafana panels.
- `order_budget_guard` should sit between risk sizing and any live gateway to avoid bypassing throttle rules.
- Keep `configs/risk_budget.yaml` under IaC practices; diffs materially change allowable exposure.
